<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini ALO World</title>
<style>
body {margin:0; overflow:hidden;}
canvas {display:block;}
#ui{
  position:absolute; top:10px; left:10px; color:white; font-family:Arial;
}
</style>
</head>
<body>
<div id="ui">
HP: <span id="hp">100</span> | Mana: <span id="mana">100</span> | Score: <span id="score">0</span>
<br>Quest: <span id="quest">Collect 3 coins</span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/PointerLockControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// ===== Scene & Camera =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,5,10);

// ===== Renderer =====
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ===== Lighting =====
const dirLight = new THREE.DirectionalLight(0xffffff,1);
dirLight.position.set(50,50,50);
scene.add(dirLight);
scene.add(new THREE.AmbientLight(0xcccccc,0.4));

// ===== Controls =====
const controls = new THREE.PointerLockControls(camera, document.body);
document.body.addEventListener('click',()=>controls.lock());

// ===== Key controls =====
const keys = {};
document.addEventListener('keydown', e=> keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);

// ===== Player =====
let player, playerMixer;
let playerHP = 100, playerMana = 100, playerScore = 0;
const loader = new THREE.GLTFLoader();

// Player ALO anime model
loader.load('https://models.babylonjs.com/SkinnedMesh/Alien.glb', gltf=>{
    player = gltf.scene;
    player.scale.set(0.5,0.5,0.5);
    player.position.set(0,0,0);
    scene.add(player);
    playerMixer = new THREE.AnimationMixer(player);
    if(gltf.animations[0]) playerMixer.clipAction(gltf.animations[0]).play();
});

// ===== Floating Islands =====
const islands=[];
function createIsland(x,z,y){
    const geo = new THREE.BoxGeometry(10,0.5,10);
    const mat = new THREE.MeshStandardMaterial({color:0x228B22});
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(x,y,z);
    scene.add(mesh);
    islands.push(mesh);
}
createIsland(0,0,0);
createIsland(15,5,2);
createIsland(-15,-10,4);
createIsland(30,-5,1);

// ===== Bridges =====
function createBridge(x1,z1,y1,x2,z2,y2){
    const dx = x2-x1, dz = z2-z1, dy = y2-y1;
    const length = Math.sqrt(dx*dx + dz*dz);
    const geo = new THREE.BoxGeometry(length,0.3,1);
    const mat = new THREE.MeshStandardMaterial({color:0x8B4513});
    const bridge = new THREE.Mesh(geo, mat);
    bridge.position.set((x1+x2)/2, (y1+y2)/2, (z1+z2)/2);
    bridge.lookAt(x2,(y1+y2)/2,z2);
    scene.add(bridge);
}
createBridge(0,0,0,15,5,2);

// ===== Trees / Forest =====
function createTree(x,z,y){
    const trunkGeo = new THREE.CylinderGeometry(0.3,0.3,2);
    const trunkMat = new THREE.MeshStandardMaterial({color:0x8B4513});
    const trunk = new THREE.Mesh(trunkGeo,trunkMat);
    trunk.position.set(x,y+1,z);
    scene.add(trunk);
    const leavesGeo = new THREE.ConeGeometry(1,2,8);
    const leavesMat = new THREE.MeshStandardMaterial({color:0x00ff00});
    const leaves = new THREE.Mesh(leavesGeo,leavesMat);
    leaves.position.set(x,y+2,z);
    scene.add(leaves);
}
createTree(0,0,0);
createTree(5,0,0);
createTree(15,5,2);

// ===== Coins / Items =====
const items=[];
function createCoin(x,y,z){
    const geo = new THREE.SphereGeometry(0.3,8,8);
    const mat = new THREE.MeshStandardMaterial({color:0xFFD700});
    const coin = new THREE.Mesh(geo, mat);
    coin.position.set(x,y,z);
    scene.add(coin);
    items.push(coin);
}
createCoin(5,1,0);
createCoin(-5,1,5);
createCoin(10,1,5);

// ===== Enemies & Boss =====
const enemies=[];
function spawnEnemy(x,y,z, hp=50, isBoss=false){
    loader.load('https://models.babylonjs.com/SkinnedMesh/Alien.glb', gltf=>{
        const enemy = gltf.scene;
        enemy.scale.set(isBoss?1:0.3, isBoss?1:0.3, isBoss?1:0.3);
        enemy.position.set(x,y,z);
        scene.add(enemy);
        enemies.push({mesh:enemy, hp:hp, waypoints:[{x:x+5,z:z},{x:x-5,z:z}], dir:1, isBoss:isBoss});
    });
}
spawnEnemy(10,0,0);
spawnEnemy(-10,0,-5);
spawnEnemy(20,0,5,150,true); // Boss

// ===== Jump/Fly =====
let velocityY = 0;
let canJump = true;

// ===== Attack / Skills =====
function attack(){
    if(playerMana<10) return;
    playerMana -=10;
    document.getElementById("mana").innerText = Math.floor(playerMana);
    enemies.forEach(e=>{
        if(player.position.distanceTo(e.mesh.position)<2){
            e.hp -= 30; // attack damage
            if(e.hp<=0){
                scene.remove(e.mesh);
                enemies.splice(enemies.indexOf(e),1);
                playerScore += e.isBoss?50:10;
                document.getElementById("score").innerText = playerScore;
            }
        }
    });
}
window.addEventListener('keydown', e=>{
    if(e.key.toLowerCase()==='f') attack();
});

// ===== Animate Loop =====
const clock = new THREE.Clock();
function animate(){
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    if(playerMixer) playerMixer.update(delta);

    // Player movement
    const speed = 0.2;
    if(player){
        if(keys['w']) player.position.z -= speed;
        if(keys['s']) player.position.z += speed;
        if(keys['a']) player.position.x -= speed;
        if(keys['d']) player.position.x += speed;
        if(keys[' ']){velocityY= canJump?0.3:velocityY; canJump=false;}
        velocityY -= 0.01;
        player.position.y += velocityY;
        if(player.position.y<0.5){player.position.y=0.5;velocityY=0;canJump=true;}
    }

    // Camera follow
    if(player){
        camera.position.x = player.position.x;
        camera.position.z = player.position.z + 10;
        camera.position.y = player.position.y + 5;
        camera.lookAt(player.position);
    }

    // Enemy patrol AI
    enemies.forEach(e=>{
        const targetWP = e.waypoints[e.dir];
        const dirVec = new THREE.Vector3(targetWP.x - e.mesh.position.x,
